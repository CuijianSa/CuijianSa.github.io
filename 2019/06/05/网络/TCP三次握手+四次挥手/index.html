<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>TCP三次握手+四次挥手 | CuijianSa.github.io</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="三次握手流程图 解决的问题:以最小的握手次数，达到C-S可靠的连接 过程 第一次握手: 建立连接时，客户端发送SYN(seq = x)包,并进入SYS_SENT状态，并等待信号回复 第二次握手: 服务端收到SYN包，必须确定客户的SYN，并且同时发送SYN+ACK(seq = y, ack = x+1)包，此时服务器进入SYN_RECV状态 第三次握手: 客户端收到服务器的SYN+ACK包，并向服">
<meta property="og:type" content="article">
<meta property="og:title" content="TCP三次握手+四次挥手">
<meta property="og:url" content="http://yoursite.com/2019/06/05/网络/TCP三次握手+四次挥手/index.html">
<meta property="og:site_name" content="CuijianSa.github.io">
<meta property="og:description" content="三次握手流程图 解决的问题:以最小的握手次数，达到C-S可靠的连接 过程 第一次握手: 建立连接时，客户端发送SYN(seq = x)包,并进入SYS_SENT状态，并等待信号回复 第二次握手: 服务端收到SYN包，必须确定客户的SYN，并且同时发送SYN+ACK(seq = y, ack = x+1)包，此时服务器进入SYN_RECV状态 第三次握手: 客户端收到服务器的SYN+ACK包，并向服">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://yoursite.com/2019/06/05/网络/TCP三次握手+四次挥手/connect.png">
<meta property="og:image" content="http://yoursite.com/2019/06/05/网络/TCP三次握手+四次挥手/disconnect.png">
<meta property="og:updated_time" content="2019-06-09T06:29:13.022Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="TCP三次握手+四次挥手">
<meta name="twitter:description" content="三次握手流程图 解决的问题:以最小的握手次数，达到C-S可靠的连接 过程 第一次握手: 建立连接时，客户端发送SYN(seq = x)包,并进入SYS_SENT状态，并等待信号回复 第二次握手: 服务端收到SYN包，必须确定客户的SYN，并且同时发送SYN+ACK(seq = y, ack = x+1)包，此时服务器进入SYN_RECV状态 第三次握手: 客户端收到服务器的SYN+ACK包，并向服">
<meta name="twitter:image" content="http://yoursite.com/2019/06/05/网络/TCP三次握手+四次挥手/connect.png">
  
    <link rel="alternate" href="/atom.xml" title="CuijianSa.github.io" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">CuijianSa.github.io</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Olin&#39;s blog</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-网络/TCP三次握手+四次挥手" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/05/网络/TCP三次握手+四次挥手/" class="article-date">
  <time datetime="2019-06-05T15:55:54.000Z" itemprop="datePublished">2019-06-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/网络/">网络</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      TCP三次握手+四次挥手
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h1><h2 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h2><p><img src="/2019/06/05/网络/TCP三次握手+四次挥手/connect.png" alt=""></p>
<h2 id="解决的问题"><a href="#解决的问题" class="headerlink" title="解决的问题:"></a>解决的问题:</h2><p>以最小的握手次数，达到C-S可靠的连接</p>
<h2 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h2><ul>
<li>第一次握手: 建立连接时，客户端发送SYN(seq = x)包,并进入SYS_SENT状态，并等待信号回复</li>
<li>第二次握手: 服务端收到SYN包，必须确定客户的SYN，并且同时发送SYN+ACK(seq = y, ack = x+1)包，此时服务器进入SYN_RECV状态</li>
<li>第三次握手: 客户端收到服务器的SYN+ACK包，并向服务器发送确认包ACK(seq = x+1, ack = y+1),此时客户端及服务端ESTABLISHED状态</li>
</ul>
<h1 id="四次挥手"><a href="#四次挥手" class="headerlink" title="四次挥手"></a>四次挥手</h1><h2 id="流程图-1"><a href="#流程图-1" class="headerlink" title="流程图"></a>流程图</h2><p><img src="/2019/06/05/网络/TCP三次握手+四次挥手/disconnect.png" alt=""></p>
<h2 id="解决的问题-1"><a href="#解决的问题-1" class="headerlink" title="解决的问题:"></a>解决的问题:</h2><p>实现C-S间挥手同步，因为涉及到数据的断开，多了一次挥手</p>
<h2 id="过程-1"><a href="#过程-1" class="headerlink" title="过程"></a>过程</h2><ul>
<li>客户端发送连接释放报文，并且停止发送数据。FIN = 1,seq = u并进入FIN-WAIT-1状态</li>
<li>服务器收到FIN，并发出确认报文，ACK=1, ack = u+1,此时进入CLOSW-WAIT状态，并通知应用层客户端向服务端方向连接断开，此时客户端没有数据要发送了，此时服务器发送数据，客户端依然要接收</li>
<li>客户端收到服务器的确认请求后，客户端进入FIN-WAIT-2状态，等待服务器发送连接断开请求</li>
<li>服务器将最后的数据发送完毕后，向客户端发送连接释放报文,FIN=1,ack=u+1,服务器进入LAST-ACK状态</li>
<li>客户收到服务器的连接释放报文，必须发出确认，ACK=1,ack=w+1,seq=u+1,此时客户端进入TIME-WAIT状态。</li>
<li>注意此时TCP连接还没有释放，必须经过2∗∗MSL（最长报文段寿命）的时间后，当客户端撤销相应的TCB后，才进入CLOSED状态</li>
<li>服务器只要收到了客户端发出的确认，立即进入CLOSED状态。同样，撤销TCB后，就结束了这次的TCP连接。可以看到，服务器结束TCP连接的时间要比客户端早一些</li>
</ul>
<h1 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h1><ul>
<li>为什么连接的时候是三次握手，关闭的时候却是四次握手</li>
</ul>
<p>因为当Server收到Client端的SYN连接请求报文后，可以直接发送SYN+ACK报文。其中SYN用来同步，ACK报文用来应答。在关闭连接时，Server收到FIN时，可能不会立即关闭SOCKET，可能并不会立即关闭SCOKET，所以只能先回复一个ACK报文，告诉Client端,”你发的FIN报文我收到了”。只有等到我Server端所有的报文都发送完了，我才能发送FIN报文，因此不能一起发送。故需要四步握手</p>
<ul>
<li>为什么TIME_WAIT状态需要经过2MSL(最大报文段生存时间)才能返回到CLOSE状态</li>
</ul>
<p>虽然按道理，四个报文都发送完毕，我们可以直接进入CLOSE状态了，但是我们必须假象网络是不可靠的，有可以最后一个ACK丢失。所以TIME_WAIT状态就是用来重发可能丢失的ACK报文。在Client发送出最后的ACK回复，但该ACK可能丢失。Server如果没有收到ACK，将不断重复发送FIN片段。所以Client不能立即关闭，它必须确认Server接收到了该ACK。Client会在发送出ACK之后进入到TIME_WAIT状态。Client会设置一个计时器，等待2MSL的时间。如果在该时间内再次收到FIN，那么Client会重发ACK并再次等待2MSL。所谓的2MSL是两倍的MSL(Maximum Segment Lifetime)。MSL指一个片段在网络中最大的存活时间，2MSL就是一个发送和一个回复所需的最大时间。如果直到2MSL，Client都没有再次收到FIN，那么Client推断ACK已经被成功接收，则结束TCP连接。</p>
<ul>
<li>为什么不能用两次握手进行连接？</li>
</ul>
<p>3次握手完成两个重要的功能，既要双方做好发送数据的准备工作(双方都知道彼此已准备好)，也要允许双方就初始序列号进行协商，这个序列号在握手过程中被发送和确认。现在把三次握手改成仅需要两次握手，死锁是可能发生的。</p>
<p>作为例子，考虑计算机S和C之间的通信，假定C给S发送一个连接请求分组，S收到了这个分组，并发 送了确认应答分组。按照两次握手的协定，S认为连接已经成功地建立了，可以开始发送数据分组。可是，C在S的应答分组在传输中被丢失的情况下，将不知道S 是否已准备好，不知道S建立什么样的序列号，C甚至怀疑S是否收到自己的连接请求分组。在这种情况下，C认为连接还未建立成功，将忽略S发来的任何数据分 组，只等待连接确认应答分组。而S在发出的分组超时后，重复发送同样的分组。这样就形成了死锁。</p>
<ul>
<li>如果已经建立了连接，但是客户端突然出现故障了怎么办？</li>
</ul>
<p>TCP还设有一个保活计时器，显然，客户端如果出现故障，服务器不能一直等下去，白白浪费资源。服务器每收到一次客户端的请求后都会重新复位这个计时器，时间通常是设置为2小时，若两小时还没有收到客户端的任何数据，服务器就会发送一个探测报文段，以后每隔75秒钟发送一次。若一连发送10个探测报文仍然没反应，服务器就认为客户端出了故障，接着就关闭连接</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/06/05/网络/TCP三次握手+四次挥手/" data-id="cjxc06q4s0015r0vc8e4ebdqj" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/06/26/linux/linux应用程序加载/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          linux应用程序加载
        
      </div>
    </a>
  
  
    <a href="/2019/05/07/SQL/mongodb/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">mongodb</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C++</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SQL/">SQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/other/">other</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/流媒体/">流媒体</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/笔记/">笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/编译框架/">编译框架</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/06/26/linux/linux应用程序加载/">linux应用程序加载</a>
          </li>
        
          <li>
            <a href="/2019/06/05/网络/TCP三次握手+四次挥手/">TCP三次握手+四次挥手</a>
          </li>
        
          <li>
            <a href="/2019/05/07/SQL/mongodb/">mongodb</a>
          </li>
        
          <li>
            <a href="/2019/04/08/网络/epoll框架/">epoll框架</a>
          </li>
        
          <li>
            <a href="/2019/04/04/编译框架/cmake-基本命令/">cmake-基本命令</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 Jian.Cui<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>